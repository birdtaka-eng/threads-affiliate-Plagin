import os
import json
import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

COOKIES_FILE = '/threads_cookies.json'

def find_element_flexible(driver, selectors, timeout=5):
    """複数のセレクタを試して要素を見つける"""
    for by, selector in selectors:
        try:
            element = WebDriverWait(driver, timeout).until(
                EC.presence_of_element_located((by, selector))
            )
            return element
        except:
            continue
    return None

def load_cookies(driver):
    """保存されたCookieを読み込む"""
    try:
        if os.path.exists(COOKIES_FILE):
            with open(COOKIES_FILE, 'r') as f:
                cookies = json.load(f)
            for cookie in cookies:
                try:
                    driver.add_cookie(cookie)
                except:
                    pass
            print('[COOKIES] Loaded')
            return True
    except Exception as e:
        print(f'[COOKIES] Load failed: {e}')
    return False

def save_cookies(driver):
    """Cookieを保存する"""
    try:
        cookies = driver.get_cookies()
        with open(COOKIES_FILE, 'w') as f:
            json.dump(cookies, f)
        print('[COOKIES] Saved')
    except Exception as e:
        print(f'[COOKIES] Save failed: {e}')

def login_to_threads(driver):
    """ThreadsにInstagramアカウントでログイン"""
    username = os.environ.get('THREADS_USERNAME', '')
    password = os.environ.get('THREADS_PASSWORD', '')

    if not username or not password:
        print('[LOGIN] ERROR: THREADS_USERNAME and THREADS_PASSWORD required')
        return False

    try:
        print(f'[LOGIN] Current URL: {driver.current_url}')
        
        # Instagramログインページに遷移する場合がある
        time.sleep(3)
        
        # ユーザー名入力
        print('[LOGIN] Step 1: Username')
        user_selectors = [
            (By.NAME, 'username'),
            (By.CSS_SELECTOR, 'input[name="username"]'),
            (By.CSS_SELECTOR, 'input[type="text"]'),
            (By.XPATH, '//input[@aria-label="電話番号、ユーザーネーム、メールアドレス"]'),
            (By.XPATH, '//input[@aria-label="Phone number, username, or email"]'),
        ]
        user_input = find_element_flexible(driver, user_selectors, timeout=10)

        if not user_input:
            print('[LOGIN] ERROR: Username field not found')
            return False

        user_input.clear()
        user_input.send_keys(username)
        time.sleep(1)

        # パスワード入力
        print('[LOGIN] Step 2: Password')
        pass_selectors = [
            (By.NAME, 'password'),
            (By.CSS_SELECTOR, 'input[name="password"]'),
            (By.CSS_SELECTOR, 'input[type="password"]'),
        ]
        pass_input = find_element_flexible(driver, pass_selectors, timeout=5)

        if not pass_input:
            print('[LOGIN] ERROR: Password field not found')
            return False

        pass_input.clear()
        pass_input.send_keys(password)
        time.sleep(1)

        # ログインボタンをクリック
        print('[LOGIN] Step 3: Submit')
        login_selectors = [
            (By.XPATH, '//button[@type="submit"]'),
            (By.XPATH, '//button[contains(text(), "ログイン")]'),
            (By.XPATH, '//button[contains(text(), "Log in")]'),
            (By.XPATH, '//div[contains(text(), "ログイン")]'),
        ]
        login_btn = find_element_flexible(driver, login_selectors, timeout=5)
        
        if login_btn:
            driver.execute_script('arguments[0].click();', login_btn)
        else:
            pass_input.send_keys(Keys.RETURN)
        
        time.sleep(5)

        # 「後で」ボタンなどのポップアップを処理
        try:
            later_selectors = [
                (By.XPATH, '//button[contains(text(), "後で")]'),
                (By.XPATH, '//button[contains(text(), "Not now")]'),
                (By.XPATH, '//button[contains(text(), "Not Now")]'),
            ]
            later_btn = find_element_flexible(driver, later_selectors, timeout=3)
            if later_btn:
                driver.execute_script('arguments[0].click();', later_btn)
                print('[LOGIN] Dismissed popup')
                time.sleep(2)
        except:
            pass

        # ログイン成功確認
        if 'login' not in driver.current_url.lower():
            print('[LOGIN] Success')
            save_cookies(driver)
            return True
        else:
            print('[LOGIN] May have failed, checking...')
            return False

    except Exception as e:
        print(f'[LOGIN] Failed: {e}')
        return False

def post_to_threads(text, image_url=None):
    """Threadsに投稿する"""
    
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--disable-gpu')
    options.add_argument('--window-size=1920,1080')
    options.add_argument('--lang=ja')
    options.binary_location = '/usr/bin/chromium'

    service = Service('/usr/bin/chromedriver')
    driver = webdriver.Chrome(service=service, options=options)

    try:
        # まずThreadsにアクセス
        print('[1] Going to Threads...')
        driver.get('https://www.threads.net/')
        time.sleep(3)

        # Cookieを読み込んでリロード
        load_cookies(driver)
        driver.refresh()
        time.sleep(3)

        # ログインが必要か確認
        print(f'[2] Current URL: {driver.current_url}')
        
        login_required = False
        try:
            # ログインボタンがあるか確認
            login_check = driver.find_elements(By.XPATH, '//*[contains(text(), "ログイン") or contains(text(), "Log in")]')
            if login_check:
                login_required = True
        except:
            pass

        if login_required or 'login' in driver.current_url.lower():
            print('[3] Login required...')
            
            # Instagramログインページへ
            login_btn_selectors = [
                (By.XPATH, '//button[contains(text(), "ログイン")]'),
                (By.XPATH, '//button[contains(text(), "Log in")]'),
                (By.XPATH, '//a[contains(@href, "login")]'),
            ]
            login_btn = find_element_flexible(driver, login_btn_selectors, timeout=5)
            if login_btn:
                driver.execute_script('arguments[0].click();', login_btn)
                time.sleep(3)
            
            if not login_to_threads(driver):
                raise Exception('Login failed')
            
            # ログイン後、Threadsに戻る
            driver.get('https://www.threads.net/')
            time.sleep(3)

        # 新規投稿ボタンを探してクリック
        print('[4] Looking for new post button...')
        new_post_selectors = [
            (By.CSS_SELECTOR, 'svg[aria-label="作成"]'),
            (By.CSS_SELECTOR, 'svg[aria-label="Create"]'),
            (By.XPATH, '//div[@role="button"]//svg'),
            (By.CSS_SELECTOR, '[data-pressable-container="true"]'),
        ]
        
        # ホームページの「スレッドを開始」入力欄を探す
        compose_selectors = [
            (By.XPATH, '//div[contains(@class, "xzsf02u")]//div[@contenteditable="true"]'),
            (By.CSS_SELECTOR, 'div[contenteditable="true"]'),
            (By.XPATH, '//div[@role="textbox"]'),
        ]
        
        compose_area = find_element_flexible(driver, compose_selectors, timeout=10)
        
        if not compose_area:
            # 新規投稿ボタンをクリック
            new_post_btn = find_element_flexible(driver, new_post_selectors, timeout=5)
            if new_post_btn:
                driver.execute_script('arguments[0].click();', new_post_btn)
                time.sleep(2)
                compose_area = find_element_flexible(driver, compose_selectors, timeout=10)
        
        if not compose_area:
            print('[ERROR] Could not find compose area')
            driver.save_screenshot('/error_compose.png')
            raise Exception('Compose area not found')

        # テキストを入力
        print('[5] Entering text...')
        compose_area.click()
        time.sleep(0.5)
        
        # 日本語入力のため、send_keysの代わりにJavaScriptを使用
        driver.execute_script('''
            arguments[0].focus();
            document.execCommand('insertText', false, arguments[1]);
        ''', compose_area, text)
        time.sleep(1)

        # 画像がある場合はアップロード（オプション）
        if image_url:
            print('[5.5] Image upload is not implemented yet')
            # TODO: 画像アップロード機能を追加

        # 投稿ボタンをクリック
        print('[6] Clicking post button...')
        post_btn_selectors = [
            (By.XPATH, '//div[contains(text(), "投稿する")]'),
            (By.XPATH, '//div[contains(text(), "Post")]'),
            (By.XPATH, '//button[contains(text(), "投稿")]'),
            (By.CSS_SELECTOR, 'div[role="button"]'),
        ]
        
        # 投稿ボタンを探す（テキスト入力後に有効になる）
        time.sleep(1)
        post_btn = None
        for by, selector in post_btn_selectors:
            try:
                elements = driver.find_elements(by, selector)
                for el in elements:
                    if '投稿' in el.text or 'Post' in el.text:
                        post_btn = el
                        break
                if post_btn:
                    break
            except:
                continue

        if post_btn:
            driver.execute_script('arguments[0].click();', post_btn)
            time.sleep(3)
            print('[7] Post submitted!')
        else:
            print('[WARNING] Post button not found, trying Enter key')
            compose_area.send_keys(Keys.CONTROL + Keys.RETURN)
            time.sleep(3)

        # Cookieを保存
        save_cookies(driver)

        print(f'[8] Final URL: {driver.current_url}')
        print('SUCCESS')
        return True

    except Exception as e:
        print(f'ERROR: {e}')
        try:
            driver.save_screenshot('/error_threads.png')
            print('[DEBUG] Screenshot saved to /error_threads.png')
        except:
            pass
        return False
    finally:
        driver.quit()


if __name__ == '__main__':
    post_text = os.environ.get('THREADS_TEXT', '')
    image_url = os.environ.get('THREADS_IMAGE', '')

    if not post_text:
        print('ERROR: THREADS_TEXT required')
        exit(1)

    success = post_to_threads(post_text, image_url if image_url else None)
    exit(0 if success else 1)