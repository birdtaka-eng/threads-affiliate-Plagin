<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads Shokunin - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cursor-wait {
            cursor: wait;
        }

        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-8 font-sans text-gray-800">

    <header class="mb-8 flex items-center justify-between max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold flex items-center gap-2">
            üßµ Threads Shokunin
            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">ver2.0 (Fixed Categories)</span>
        </h1>
        <!-- "Add Category" button removed for fixed structure -->
    </header>

    <div class="max-w-6xl mx-auto overflow-x-auto bg-white shadow rounded-lg border border-gray-200">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-100 border-b border-gray-200">
                <tr>
                    <th class="p-4 w-1/6 font-semibold">Category</th>
                    <th class="p-4 w-1/3 font-semibold">Topic / Keywords (Prompt)</th>
                    <th class="p-4 w-1/3 font-semibold">Stock (Output)</th>
                    <th class="p-4 w-1/6 font-semibold">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100">
                <!-- Javascript will inject rows here -->
            </tbody>
        </table>
    </div>

    <!-- API Key Setting Area -->
    <div class="max-w-6xl mx-auto mt-8 p-4 bg-white border border-gray-200 rounded-lg">
        <h3 class="font-bold text-sm mb-2">‚öôÔ∏è Settings (Local Browser Only)</h3>
        <div class="flex gap-2">
            <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key here (AIza...)"
                class="flex-1 border p-2 rounded text-sm outline-none focus:border-blue-500">
            <button onclick="saveApiKey()" class="bg-gray-200 px-4 py-2 rounded text-sm hover:bg-gray-300">Save
                Key</button>
            <button onclick="clearApiKey()" class="text-red-500 text-xs px-2 hover:underline">Clear</button>
        </div>
    </div>

    <div class="mt-8 text-sm text-gray-500 text-center">
        Data is saved to your browser's <strong>LocalStorage</strong> (v2).
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- Data Definitions ---
        // 6 Fixed Categories
        const FIXED_CATEGORIES = [
            { id: '1', category: 'ÂçòÂìÅÊäïÁ®ø', desc: 'ÂïÜÂìÅ1ÁÇπ„ÇíÁ¥π‰ªã', prompt: '' },
            { id: '2', category: 'ÊúâÁõä„Éç„Çø', desc: 'Áü•Ë≠ò„Éª„Éé„Ç¶„Éè„Ç¶', prompt: '' },
            { id: '3', category: 'Êó•Â∏∏„Éª„Éç„Çø', desc: 'ÂÖ±ÊÑü„ÉªÁ¨ë„ÅÑ', prompt: '' },
            { id: '4', category: '„Åæ„Å®„ÇÅÊäïÁ®ø', desc: '„É™„Çπ„ÉàÂΩ¢Âºè', prompt: '' },
            { id: '5', category: '„É™„É≥„ÇØÁÑ°ÊäïÁ®ø', desc: '‰∫§ÊµÅ„Éª„Ç§„É≥„ÉóÁ®º„Åé', prompt: '' },
            { id: '6', category: 'Ëá™Â∑±Á¥π‰ªã„ÉªÊÉ≥„ÅÑ', desc: '„Éï„Ç°„É≥Âåñ', prompt: '' }
        ];

        let rows = [];
        let geminiKey = '';

        // --- Initialization ---
        window.onload = () => {
            // Load Data (using v2 key to force migration to new structure)
            const saved = localStorage.getItem('shokunin_data_v2');
            if (saved) {
                rows = JSON.parse(saved);
                // Ensure all 6 categories exist even if saved data is old (simple merge logic could go here, but v2 ensures fresh start for now)
            } else {
                // Initialize with empty stocks
                rows = FIXED_CATEGORIES.map(c => ({
                    id: c.id,
                    category: c.category,
                    desc: c.desc,
                    prompt: '', // User input
                    stock: ''   // AI Output
                }));
            }

            // Load Key
            geminiKey = localStorage.getItem('gemini_api_key') || '';
            if (geminiKey) document.getElementById('apiKeyInput').value = '*'.repeat(20);

            render();
        };

        // --- Global Functions ---
        window.saveApiKey = () => {
            const val = document.getElementById('apiKeyInput').value;
            if (val && !val.startsWith('***')) {
                localStorage.setItem('gemini_api_key', val);
                geminiKey = val;
                alert('API Key Saved!');
                document.getElementById('apiKeyInput').value = '*'.repeat(20);
            }
        };

        window.clearApiKey = () => {
            localStorage.removeItem('gemini_api_key');
            geminiKey = '';
            document.getElementById('apiKeyInput').value = '';
            alert('Key Cleared');
        };

        window.updateRow = (id, field, value) => {
            const row = rows.find(r => r.id === id);
            if (row) {
                row[field] = value;
                saveData();
            }
        };

        // Note: Add/Delete functions removed as categories are fixed.

        window.handleGenerate = async (id) => {
            const row = rows.find(r => r.id === id);
            if (!row.prompt) return alert("Please enter a Topic/Keyword.");
            if (!geminiKey) return alert("Please set your Gemini API Key below.");

            // UI Loading
            const btn = document.getElementById(`btn-gen-${id}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ü§ñ Thinking...';
            btn.disabled = true;
            btn.className = "w-full bg-blue-400 text-white px-3 py-2 rounded text-sm font-bold shadow-sm cursor-wait";

            try {
                const genAI = new GoogleGenerativeAI(geminiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });

                // Future: Construct a better prompt based on Category + User Input
                // For now: Just pass the user input directly
                const finalPrompt = `„Äê„Ç´„ÉÜ„Ç¥„É™: ${row.category}„Äë\n${row.prompt}\n\n„Åì„ÅÆÊù°‰ª∂„ÅßThreads„ÅÆÊäïÁ®øÊñá„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                const result = await model.generateContent(finalPrompt);
                const response = await result.response;
                const text = response.text();

                row.stock = text;
                saveData();
                document.getElementById(`input-stock-${id}`).value = text;
                render();

            } catch (err) {
                alert("Error: " + err.message);
                btn.innerHTML = originalText;
                btn.className = "w-full bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow-sm hover:bg-blue-700 transition";
                btn.disabled = false;
            }
        };

        window.handleCopyToExt = (id) => {
            const row = rows.find(r => r.id === id);
            if (!row.stock) return;
            navigator.clipboard.writeText(row.stock).then(() => {
                alert('Copied! üìã\nPaste into Extension.');
            });
        };

        function saveData() {
            localStorage.setItem('shokunin_data_v2', JSON.stringify(rows));
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                const safePrompt = escapeHtml(row.prompt);
                const safeStock = escapeHtml(row.stock);

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition border-b border-gray-100';

                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-gray-800">${row.category}</div>
                        <div class="text-xs text-gray-500 mt-1">${row.desc || ''}</div>
                    </td>
                    <td class="p-4 align-top">
                        <textarea oninput="updateRow('${row.id}', 'prompt', this.value)"
                            class="w-full h-24 border border-gray-300 rounded p-2 text-sm outline-none focus:border-blue-500 resize-none"
                            placeholder="Enter keywords or instructions...">${safePrompt}</textarea>
                    </td>
                    <td class="p-4 align-top">
                        <textarea id="input-stock-${row.id}" oninput="updateRow('${row.id}', 'stock', this.value)"
                            class="w-full h-24 bg-slate-50 border border-gray-200 rounded p-2 text-sm text-gray-700 resize-none"
                            placeholder="(AI Output)">${safeStock}</textarea>
                    </td>
                    <td class="p-4 align-top space-y-2">
                        <button id="btn-gen-${row.id}" onclick="handleGenerate('${row.id}')"
                            class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow-sm hover:bg-blue-700 transition">
                            ‚ú® Generate
                        </button>
                        <button onclick="handleCopyToExt('${row.id}')" ${!row.stock ? 'disabled' : ''}
                            class="w-full px-3 py-2 rounded text-sm font-bold shadow-sm border
                            ${!row.stock ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                            üìã Copy
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    </script>
</body>

</html>