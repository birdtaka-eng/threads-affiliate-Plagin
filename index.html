<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads Shokunin - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cursor-wait {
            cursor: wait;
        }

        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-8 font-sans text-gray-800">

    <header class="mb-8 flex items-center justify-between max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold flex items-center gap-2">
            üßµ Threads Shokunin
            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">ver2.1 (Affiliate Mode)</span>
        </h1>
    </header>

    <div class="max-w-7xl mx-auto overflow-x-auto bg-white shadow rounded-lg border border-gray-200">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-100 border-b border-gray-200">
                <tr>
                    <th class="p-4 w-48 font-semibold">Category</th>
                    <th class="p-4 font-semibold">Inputs (Keywords & Image)</th>
                    <th class="p-4 w-1/3 font-semibold">Stock (Output)</th>
                    <th class="p-4 w-32 font-semibold">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
        </table>
    </div>

    <!-- API Key Setting Area -->
    <div class="max-w-7xl mx-auto mt-8 p-4 bg-white border border-gray-200 rounded-lg">
        <h3 class="font-bold text-sm mb-2">‚öôÔ∏è Settings (Local Browser Only)</h3>
        <div class="flex gap-2">
            <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key here (AIza...)"
                class="flex-1 border p-2 rounded text-sm outline-none focus:border-blue-500">
            <button onclick="saveApiKey()" class="bg-gray-200 px-4 py-2 rounded text-sm hover:bg-gray-300">Save
                Key</button>
            <button onclick="clearApiKey()" class="text-red-500 text-xs px-2 hover:underline">Clear</button>
        </div>
    </div>

    <div class="mt-8 text-sm text-gray-500 text-center">
        Data is saved to your browser's LocalStorage (v2.1).
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // Categories
        const FIXED_CATEGORIES = [
            { id: '1', category: 'ÂçòÂìÅÊäïÁ®ø', desc: 'ÂïÜÂìÅÁ¥π‰ªã (Image„ÅÇ„Çä)', isAffiliate: true },
            { id: '2', category: 'ÊúâÁõä„Éç„Çø', desc: 'Áü•Ë≠ò„Éª„Éé„Ç¶„Éè„Ç¶', isAffiliate: false },
            { id: '3', category: 'Êó•Â∏∏„Éª„Éç„Çø', desc: 'ÂÖ±ÊÑü„ÉªÁ¨ë„ÅÑ', isAffiliate: false },
            { id: '4', category: '„Åæ„Å®„ÇÅÊäïÁ®ø', desc: '„É™„Çπ„ÉàÂΩ¢Âºè', isAffiliate: false },
            { id: '5', category: '„É™„É≥„ÇØÁÑ°ÊäïÁ®ø', desc: '‰∫§ÊµÅ„Éª„Ç§„É≥„ÉóÁ®º„Åé', isAffiliate: false },
            { id: '6', category: 'Ëá™Â∑±Á¥π‰ªã„ÉªÊÉ≥„ÅÑ', desc: '„Éï„Ç°„É≥Âåñ', isAffiliate: false }
        ];

        let rows = [];
        let geminiKey = '';

        window.onload = () => {
            // Load key
            geminiKey = localStorage.getItem('gemini_api_key') || '';
            if (geminiKey) document.getElementById('apiKeyInput').value = '*'.repeat(20);

            // Load Data
            const saved = localStorage.getItem('shokunin_data_v21');
            if (saved) {
                rows = JSON.parse(saved);
            } else {
                // Init structure
                rows = FIXED_CATEGORIES.map(c => ({
                    id: c.id,
                    category: c.category,
                    desc: c.desc,
                    isAffiliate: c.isAffiliate,
                    prompt: '',
                    imageUrl: '', // New field
                    stock: ''
                }));
            }
            render();
        };

        // --- Render ---
        function render() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                const safePrompt = escapeHtml(row.prompt);
                const safeStock = escapeHtml(row.stock);
                const safeImg = escapeHtml(row.imageUrl || '');

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition border-b border-gray-100';

                // --- Input Column Construction ---
                let inputHtml = `
                    <textarea oninput="updateRow('${row.id}', 'prompt', this.value)"
                        class="w-full h-20 border border-gray-300 rounded p-2 text-sm outline-none focus:border-blue-500 resize-none mb-2"
                        placeholder="${row.isAffiliate ? 'ÂïÜÂìÅÂêç„ÄÅÁâπÂæ¥„ÄÅ„Çø„Éº„Ç≤„ÉÉ„ÉàÂ±§„Å™„Å©...' : '„Ç≠„Éº„ÉØ„Éº„Éâ„ÇÑÊåáÁ§∫„ÇíÂÖ•Âäõ...'}">${safePrompt}</textarea>
                `;

                // Add Image Input for Affiliate Row
                if (row.isAffiliate) {
                    inputHtml += `
                        <div class="flex gap-2 items-center">
                            <input type="text" value="${safeImg}" 
                                oninput="updateRow('${row.id}', 'imageUrl', this.value)"
                                class="flex-1 border border-gray-300 rounded p-1 text-xs outline-none focus:border-blue-500"
                                placeholder="Image URL (http://...)">
                            ${row.imageUrl ? `<img src="${safeImg}" class="h-10 w-10 object-cover rounded border border-gray-300" title="Preview">` : ''}
                        </div>
                    `;
                }

                tr.innerHTML = `
                    <td class="p-4 align-top w-48">
                        <div class="font-bold text-gray-800 text-sm">${row.category}</div>
                        <div class="text-xs text-gray-500 mt-1">${row.desc}</div>
                    </td>
                    <td class="p-4 align-top">
                        ${inputHtml}
                    </td>
                    <td class="p-4 align-top">
                        <textarea id="input-stock-${row.id}" oninput="updateRow('${row.id}', 'stock', this.value)"
                            class="w-full h-24 bg-slate-50 border border-gray-200 rounded p-2 text-sm text-gray-700 resize-none font-mono"
                            placeholder="(AI Output)">${safeStock}</textarea>
                    </td>
                    <td class="p-4 align-top space-y-2 w-32">
                        <button id="btn-gen-${row.id}" onclick="handleGenerate('${row.id}')"
                            class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow-sm hover:bg-blue-700 transition">
                            ‚ú® Generate
                        </button>
                        <button onclick="handleCopyToExt('${row.id}')" ${!row.stock ? 'disabled' : ''}
                            class="w-full px-3 py-2 rounded text-sm font-bold shadow-sm border
                            ${!row.stock ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                            üìã Copy
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Logic ---

        window.updateRow = (id, field, value) => {
            const row = rows.find(r => r.id === id);
            if (row) {
                row[field] = value;
                saveData();
                if (field === 'imageUrl') render(); // re-render to update preview
            }
        };

        window.handleGenerate = async (id) => {
            const row = rows.find(r => r.id === id);
            if (!row.prompt) return alert("Please enter keywords.");
            if (!geminiKey) return alert("Please set your Gemini API Key.");

            const btn = document.getElementById(`btn-gen-${id}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ü§ñ Thinking...';
            btn.disabled = true;
            btn.className = "w-full bg-blue-400 text-white px-3 py-2 rounded text-sm font-bold shadow-sm cursor-wait";

            try {
                const genAI = new GoogleGenerativeAI(geminiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });

                let systemPrompt = "";

                if (row.isAffiliate) {
                    // Specialized prompt for Affiliate
                    systemPrompt = `
„ÅÇ„Å™„Åü„ÅØSNS„Ç¢„Éï„Ç£„É™„Ç®„Ç§„Éà„ÅÆ„Éó„É≠„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆÂïÜÂìÅ„Å´„Å§„ÅÑ„Å¶„ÄÅThreadsÔºà„Çπ„É¨„ÉÉ„Ç∫Ôºâ„Å´ÊäïÁ®ø„Åô„Çã„Åü„ÇÅ„ÅÆ„Äå„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Åè„Å™„ÇãÁ¥π‰ªãÊñá„Äç„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÁîªÂÉè„Å®‰∏ÄÁ∑í„Å´ÊäïÁ®ø„Åô„Çã„Åü„ÇÅ„ÄÅÁîªÂÉè„ÅÆË™¨Êòé„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ„ÄåÁîªÂÉè„ÅßÁ¥π‰ªã„Åó„Åü„Åì„Çå„ÄÅÂÆü„ÅØ...„Äç„ÅÆ„Çà„ÅÜ„Å™ÁîªÂÉè„Å∏„ÅÆË™òÂ∞é„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Åæ„Åü„ÄÅÊúÄÂæå„Å´Ëá™ÁÑ∂„Å´ÂïÜÂìÅ„É™„É≥„ÇØ„Å∏„ÅÆË™òÂ∞éÔºà„Äå„Éó„É≠„Éï„ÅÆ„É™„É≥„ÇØ„Å∏ÔºÅ„Äç„Å™„Å©Ôºâ„ÇíÊ∑ª„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂÖ•ÂäõÊÉÖÂ†±: ${row.prompt}
`;
                } else {
                    // Standard prompt
                    systemPrompt = `
ThreadsÔºà„Çπ„É¨„ÉÉ„Ç∫ÔºâÁî®„ÅÆÊäïÁ®øÊñá„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Ç´„ÉÜ„Ç¥„É™: ${row.category}
ÂÜÖÂÆπ: ${row.prompt}
`;
                }

                const result = await model.generateContent(systemPrompt);
                const text = result.response.text();

                row.stock = text;
                saveData();
                document.getElementById(`input-stock-${id}`).value = text;
                render();

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.className = "w-full bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow-sm hover:bg-blue-700 transition";
                btn.disabled = false;
            }
        };

        window.handleCopyToExt = (id) => {
            const row = rows.find(r => r.id === id);
            if (!row.stock) return;
            navigator.clipboard.writeText(row.stock).then(() => {
                alert('Copied! üìã\nPaste into Extension.');
            });
        };

        // Key Management helpers (same as before)
        window.saveApiKey = () => {
            const val = document.getElementById('apiKeyInput').value;
            if (val && !val.startsWith('***')) {
                localStorage.setItem('gemini_api_key', val);
                geminiKey = val;
                alert('Saved!');
                document.getElementById('apiKeyInput').value = '*'.repeat(20);
                render(); // Reload to check state
            }
        };
        window.clearApiKey = () => {
            localStorage.removeItem('gemini_api_key');
            geminiKey = '';
            document.getElementById('apiKeyInput').value = '';
        };

        function saveData() {
            localStorage.setItem('shokunin_data_v21', JSON.stringify(rows));
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    </script>
</body>

</html>